<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Voice Sheet App</title>
  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="assets/style.css">
  <link rel="manifest" href="manifest.json">
  <!-- External libraries -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header class="app-header">
    <div class="left">
      <button id="btn-new" title="New Grid (fresh sheet)">New Grid</button>
      <button id="btn-clear" title="Clear all cells">Clear Grid</button>
      <div class="dropdown">
        <button class="dropbtn">Import ▾</button>
        <div class="dropdown-content">
          <label class="file-label">Excel (.xlsx)
            <input type="file" id="file-import-xlsx" accept=".xlsx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"/>
          </label>
          <label class="file-label">CSV (.csv)
            <input type="file" id="file-import-csv" accept=".csv,text/csv"/>
          </label>
          <label class="file-label">TSV (.tsv)
            <input type="file" id="file-import-tsv" accept=".tsv,text/tab-separated-values"/>
          </label>
        </div>
      </div>
      <div class="dropdown">
        <button class="dropbtn">Export ▾</button>
        <div class="dropdown-content">
          <button id="export-xlsx">Excel (.xlsx)</button>
          <button id="export-csv">CSV (.csv)</button>
          <button id="export-tsv">TSV (.tsv)</button>
        </div>
      </div>
    </div>
    <div class="right">
      <div class="voice-controls">
        <button id="btn-mic" title="Start/Stop voice recognition">Mic ▶</button>
        <label>Auto-advance
          <input type="checkbox" id="autoAdvance" checked>
        </label>
        <label>Direction
          <select id="advanceDir">
            <option value="right">Right</option>
            <option value="left">Left</option>
            <option value="down" selected>Down</option>
            <option value="up">Up</option>
          </select>
        </label>
        <label>Silence (ms)
          <input id="silenceMs" type="number" min="250" step="100" value="1000">
        </label>
      </div>
    </div>
  </header>

  <main>
    <div id="grid" class="grid"></div>
  </main>

  <footer class="statusbar">
    <div id="status">Ready</div>
    <div class="spacer"></div>
    <div class="hint">Shortcuts: ⌘/Ctrl+C/X/V, Delete, ⌘/Ctrl+Z / ⌘/Ctrl+Shift+Z (or Y), Arrows, Tab/Shift+Tab, Enter/Shift+Enter</div>
  </footer>

  <!-- App scripts -->
  <script type="module">
    import { createGrid } from './src/grid.js';
    import { setupSpeech } from './src/speech.js';
    import { setupExportImport } from './src/export.js';
    import { storage } from './src/storage.js';

    const gridEl = document.getElementById('grid');
    const grid = createGrid(gridEl, {
      rows: 50,
      cols: 26,
    });

    // Persist column widths
    const savedWidths = storage.get('colWidths');
    if (savedWidths) grid.setColumnWidths(savedWidths);
    grid.on('colWidthChange', widths => storage.set('colWidths', widths));

    // Header buttons
    document.getElementById('btn-new').addEventListener('click', () => {
      grid.reset(50, 26);
      storage.set('colWidths', grid.getColumnWidths());
    });
    document.getElementById('btn-clear').addEventListener('click', () => {
      grid.clear();
    });

    // Import/Export
    setupExportImport(grid);

    // Speech
    const speech = setupSpeech({
      onNumber: (numStr) => {
        // Accept only numeric; no undo entry for voice inputs
        if (!/^[-+]?\d*(?:\.\d+)?$/.test(numStr) || numStr.trim()==='') return;
        grid.editCurrentCell(numStr, { pushUndo: false });
        if (document.getElementById('autoAdvance').checked) {
          const dir = document.getElementById('advanceDir').value;
          grid.moveSelection(dir);
        }
      },
      onStatus: (text) => document.getElementById('status').textContent = text,
      getSilenceMs: () => parseInt(document.getElementById('silenceMs').value || '1000', 10),
      getButton: () => document.getElementById('btn-mic'),
    });

    // Keyboard navigation handled in grid.js

    window.grid = grid; // expose for debugging
    window.speech = speech;
  </script>
</body>
</html>
